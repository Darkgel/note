第十章 复制

复制概述
    mysql支持两种复制方式：
        1.基于行的复制
        2.基于语句的复制

        这两种方式都是通过在主库上记录二进制日志，在备库重放日志的方式来实现异步的数据复制

        复制通常不会增加主库的开销，主要是启用二进制日志带来的开销，但出于备份或及时从崩溃中回复的目的，这点开销也是必要的。

        mysql复制数据的三个步骤：
            1.在主库上把数据更改记录到二进制日志（Binary Log）中
            2.备库将主库上的日志复制到自己的中继日志（Relay Log）中
            3.备库读取中继日志中的事件，将其重放到备库数据之上

配置复制
    配置复制的步骤：
        1.在每台服务器上创建复制账号
        2.配置主库和备库
        3.通知备库连接到主库并从主库复制数据

    初始化备库或者从其他服务器克隆数据到备库。
    包括从主库复制数据，从另外一台备库克隆数据，以及使用最近的一次备份来启动备库，需要有有三个条件来让主库和备库保持同步：
        1.在某个时间点的主库的数据快照
        2.主库当前的二进制日志文件，和获得数据快照时在该二进制日志文件中的偏移量。（可以通过SHOW MASTER STATUS命令来获取这些值）
        3.从快照时间到现在的二进制日志


复制的原理
    基于语句的复制
        主库会记录那些造成数据更改的查询，当备库读取并重放这些事件时，实际上只是把主库上执行过的SQL再执行一遍。

    基于行的复制
        将实际数据记录在二进制日志中



复制拓扑
    可以在任意个主库和备库之间建立复制，只有一个限制：每个备库只能有一个主库

    需要记住的一些基本原则:
        1.一个mysql备库实例只能有一个主库
        2.每个备库必须有一个唯一的服务器id
        3.一个主库可以有多个备库
        4.如果打开了log_slave_updates选项，一个备库可以把其主库上的数据变化传播到其他备库


    一主库多备库
        适用于：有少量写和大量读时

        可以把读分摊到多个备库上，制动备库给主库造成了太大的负担，或者主备之间的带宽成为瓶颈为止

        一些用途：
            1.为不同的角色使用不同的备库（例如添加不同的索引或使用不同的存储引擎）
            2.把一台备库当作待用的主库，除了复制没有其他数据传输
            3.将一台备库放到远程数据中心，用作灾难恢复
            4.延迟一个或多个备库，以备灾难恢复
            5.使用之中一个备库，作为备份，培训，开发或者测试使用

    主动-主动模式下的主-主复制
        主-主复制（也叫双主复制或双向复制）包含两台服务器，每一个都被配置成为对方的主库和备库，换句话说，它们是一对主库

        应用场景:
            1.处于不同地理位置的办公室都需要一份可写的数据拷贝

        存在的问题：当两台服务器同时修改一行记录，或同时在两台服务器上向一个包含AUTO_INCREMENT列的表里插入数据


    主动-被动模式下的主-主复制
        是上一个主-主结构的变体，能够避免其存在的问题。这也是构架容错性和高可用性系统的非常强大的方式，主要区别在于其中的一台服务器是只读的被动服务器

        这种方式使得反复切换主动和被动服务器特别方便，因为服务器的配置是对称的。这使得故障转移和故障恢复很容易。

        如何配置
            1.确保每台服务器上有相同的数据
            2.启用备库更新的日志记录，后面将会看到，这是故障转移和故障恢复的关键
            3.把被动服务器配置成只读，防止可能与主动服务器上的更新产生冲突，这一点是可选的
            4.启动每个服务器的mysql实例
            5.将每个主库设置为对方的备库，使用新创建的二进制日志开始工作

        应用：
            例如，执行ALTER TABLE操作可能会锁住整个表，阻塞对表的读和写，这可能会花费很长时间并导致服务中断。
            然而在主-主配置下，可以先停止主动服务器上的备库复制线程（这样就不会在被动服务器上执行任何更新），然后在被动服务器上执行ALTER操作，交换角色，
            最后在先前的主动服务器上启动复制线程。这个服务器将会读取中继日志并执行相同的ALTER语句


    拥有备库的主-主结构
        每个主库增加一个备库，增加了冗余，对于不同地理位置的复制拓扑，能够消除站点单点失效的问题

    环形复制
        双主结构实际上是环形结构的一种特例。环形结构可以有三个或更多的主库。每个服务器都是在它之前的服务器的备库，是在它时候的服务器的主库
        环形结构非常脆弱，应该尽量避免

    主库，分发主库以及备库
        当备库足够多时，会对主库造成很大的负载。如果需要多个备库，一个好办法是从主库移除负载并使用分发主库。
        分发主库事实上也是已给备库，它的唯一目的就是提取和提供主库的二进制日志。多个备库连接到分发主库，这使原来的主库摆脱了负担。
        为了避免在分发主库上做实际的查询，可以将它的表修改为 blackhole 存储引擎

    树或金字塔形
        如果正在将主库复制到大量的备库中，不管是把数据分发到不同的地方，还是提供更高的读性能，使用金字塔结构都能够更好地管理
        这种设计的好处是能够减轻主库地负担；缺点是中间层出现的任何错误都会影响到多个服务器。
        


复制和容量规划


复制管理和维护


复制的问题和解决方案



复制有多快
mysql复制的高级特性
其他复制技术